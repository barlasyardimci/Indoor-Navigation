<html>

<head>
    <title>Map Creator</title>
    <link rel="stylesheet" type="text/css" href="./css/createMap.css" />
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-auth.js"></script>
    <script src="./js/interactableBackgroundImage.js"></script>
    <script src="https://unpkg.com/konva@4.1.6/konva.min.js"></script>


    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
        }
    </style>
</head>

<body>

    <div class="topnav">
        <a href="./index.html">Home</a>
        <a class="active" href="./createMap.html">Create Map</a>
        <a href=# "asd">Edit Map</a>
        <a href="./importImage.html">Upload Image</a>
        <input type="text" id="mapNamed" required pattern="\S+" placeholder="Enter map name">
        <input type="button" id="mapbtClickMe" onclick="nclicked()" value="Submit" />
    </div>


    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <h2 class="h2">Items </h2>
        <h3 class="h3">Import Image</h3>
        <label class="label" for="imageName">Image Name:</label>
        <input type="text" id="imageName" required="required" value="">
        <button class="openbtn" type="button" onclick="setBackground();">Import!</button>

    </div>
    <container class="backgroundImageContainer" id="backgroundImageContainer"></container>
    <div id="main">
        <label class="label" for="delete">Delete Checkpoint:</label>
        <select id="dlt">
            <option value="none"></option>
        </select>
        <button class="openbutton" id="deleteClick">Delete Anchor</button>
        <button class="openbtn" onclick="openNav()">&#9776; Open Sidebar</button>
        <button class="openRbtn" onclick="openNavR()">&#9776; Add Edge</button>
        <input type="text" id="anchNamed" onkeyup="success()" required pattern="\S+" placeholder="Enter checkpoint name">
        <input type="button" id="btClickMe" disabled="true" value="Generate Checkpoint" />
        <select id="rmEdges">
            <option value="none"></option>
        </select>
        <input type="text" id="rmName" onkeyup="successRoom()" required pattern="\S+" placeholder="Enter room name">
        <input type="button" id="rmButton" disabled="true" value="Add Room To Edge" />


    </div>
    <div id="rightSideBar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNavR()">&times;</a>
        <h2 class="h2">Create Edge</h2>
        <label class="label" for="source">Source:</label>
        <select id="srce">
            <option value="none"></option>
        </select>
        <br></br>
        <label class="label" for="dest">Destination:</label>
        <select id="dtn">
            <option value="none"></option>
        </select>
        <br></br>
        <label class="label" for="comm">Way to go:</label>
        <select id="nav">
            <option value="north">North</option>
            <option value="east">East</option>
            <option value="west">West</option>
            <option value="south">South</option>
            <option value="neast">North-East</option>
            <option value="nwest">North-West</option>
            <option value="seast">South-East</option>
            <option value="swest">South-West</option>
        </select>
        <br></br>
        <label class="label" for="roomname">Enter Distance:</label>
        <input type="number" id="weight" name="weight" />
        <br></br>
        <button class="openbtn" type="button" id="addEdge" onclick="">Add Edge</button>

    </div>


</body>




</html>

<script>
    var element_pos = 0; // POSITION OF THE NEWLY CREATED ELEMENTS.
    var iCnt = 0;
    var step = 0;
    var mapN = " ";
    const firebaseConfig = {
        apiKey: "AIzaSyA3ytBSLrjxIqsuFg5uYaOP8HMgZTh-K2o",
        authDomain: "indoor-navigation-bf70e.firebaseapp.com",
        databaseURL: "https://indoor-navigation-bf70e.firebaseio.com",
        projectId: "indoor-navigation-bf70e",
        storageBucket: "indoor-navigation-bf70e.appspot.com",
        messagingSenderId: "380532941190",
        appId: "1:380532941190:web:d1c2fdf1ae2e0f6dbe8c07",
        measurementId: "G-GJLBX866TQ"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);


    var storage = firebase.storage();
    var storageRef = storage.ref();

    $(document).ready(function() {

        $('#btClickMe').click(function() {
            if ($('#anchNamed').val != "") {
                var nameanch = $('#anchNamed').val()
                var dynamic_div = $("<div/>", {
                    id: nameanch + iCnt,
                    text: "",
                }).css({
                    border: '1px dashed',
                    position: 'absolute',
                    top: $('#divContainer').height() + 100,
                    width: '50px',
                    height: '50px',
                    background: 'red',
                });
                var mySelect
                element_pos = element_pos + $('#main').width() + 20;
                step++;
                var aName = $('<p>', {
                    'text': dynamic_div.attr("id")
                })
                aName.css({
                    'text-align': 'center'
                }).appendTo(dynamic_div)

                optionText = dynamic_div.attr("id");
                optionValue = dynamic_div.attr("id");
                dynamic_div.id = optionText;
                $('#srce').append(`<option value="${optionValue}"> 
                                   ${optionText} 
                              </option>`);
                $('#dtn').append(`<option value="${optionValue}"> 
                                   ${optionText} 
                              </option>`);
                $('#dlt').append(`<option value="${optionValue}"> 
                                   ${optionText} 
                              </option>`);
                // APPEND THE NEWLY CREATED DIV TO "divContainer".
                $(dynamic_div).appendTo('#main');
                $(dynamic_div).draggable();
                $(dynamic_div).resizable();
                var database = firebase.database();
                database.ref("Maps/" + mapN + "/Nodes/" + optionText).set({
                    QRID: optionText,
                    EdgeNumber: 0
                });
                iCnt = iCnt + 1;
            }
        });
        $('#deleteClick').click(function() {
            var dltName = $("#dlt option:selected").val();
            $('#' + dltName).remove();
            $("#srce option[value=" + dltName + "]").remove();
            $("#dtn option[value=" + dltName + "]").remove();
            $("#dlt option[value=" + dltName + "]").remove();
            var rootRef = firebase.database().ref().child("Maps/" + mapN + "/Nodes");
            var assetKey = rootRef.child(dltName).remove();
        });
        $('#addEdge').click(function() {

            var esrc = $('#srce option:selected').val();
            var etrgt = $('#dtn option:selected').val();
            var navCom = $('#nav option:selected').val();
            var weight = $('#weight').val();
            var database = firebase.database();
            database.ref("Maps/" + mapN + "/Nodes/" + esrc + "/EDGES/EDGE No").set({
                Source: esrc,
                Target: etrgt,
                Weight: weight,
                navCommand: navCom
            })
            database.ref("Maps/" + mapN + "/Nodes/" + etrgt + "/EDGES/EDGE No").set({
                Source: etrgt,
                Target: esrc,
                Weight: weight,
                navCommand: navCom
            })
            optVal = esrc + "," + etrgt
            optText = esrc + "," + etrgt
            $('#rmEdges').append(`<option value="${optVal}"> 
                                   ${optText} 
                              </option>`);
        });
        $('#rmButton').click(function() {
            var roomName = $("#rmName").val();
            var roomPlace = $("#rmEdges option:selected").val();
            var database = firebase.database();
            foo = {};
            foo[roomName] = roomPlace;
            database.ref("Maps/" + mapN + "/GlobalRoomList").set({
                [roomName]: roomPlace
            })
        });
    });

    function success() {
        if (document.getElementById("anchNamed").value === "") {
            document.getElementById('btClickMe').disabled = true;
        } else {
            document.getElementById('btClickMe').disabled = false;
        }
    }

    function successRoom() {
        if (document.getElementById("rmName").value === "") {
            document.getElementById('rmButton').disabled = true;
        } else {
            document.getElementById('rmButton').disabled = false;
        }
    }

    function nclicked() {
        document.getElementById('mapbtClickMe').disabled = true;
        mapN = $('#mapNamed').val();
        firebase.database().ref("Maps/" + mapN).set({
            MapName: mapN
        })
    }
</script>

<script>
    function openNavR() {
        document.getElementById("rightSideBar").style.width = "350px";
        document.getElementById("main").style.marginRight = "350px";
    }

    function closeNavR() {
        document.getElementById("rightSideBar").style.width = "0";
        document.getElementById("main").style.marginRight = "0";
    }

    /* Set the width of the sidebar to 250px and the left margin of the page content to 250px */
    function openNav() {
        document.getElementById("mySidebar").style.width = "250px";
        document.getElementById("main").style.marginLeft = "250px";
    }

    /* Set the width of the sidebar to 0 and the left margin of the page content to 0 */
    function closeNav() {
        document.getElementById("mySidebar").style.width = "0";
        document.getElementById("main").style.marginLeft = "0";
    }
</script>



<!-- The core Firebase JS SDK is always required and must be listed first -->

<!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#config-web-app -->